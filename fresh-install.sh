#!/bin/bash

# =============================================================================
# Script d'Installation Compl√®te - Plateforme de Services √† Domicile
# =============================================================================
# Description: Installation compl√®te depuis z√©ro avec Sail
# Auteur: Claude Code Assistant
# Usage: ./fresh-install.sh [options]
# =============================================================================

set -e

# Couleurs pour l'affichage
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m' # No Color

# Variables
INSTALL_DEMO_DATA=true
RESET_DATABASE=true

# =============================================================================
# FONCTIONS UTILITAIRES
# =============================================================================

print_header() {
    clear
    echo -e "${PURPLE}"
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë                üöÄ INSTALLATION COMPL√àTE üöÄ                   ‚ïë"
    echo "‚ïë              Services √† Domicile Laravel                    ‚ïë"
    echo "‚ïë                 Installation depuis z√©ro                    ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo -e "${NC}"
}

print_step() {
    echo -e "${CYAN}‚û§ $1${NC}"
}

print_success() {
    echo -e "${GREEN}‚úÖ $1${NC}"
}

print_error() {
    echo -e "${RED}‚ùå $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}‚ö†Ô∏è  $1${NC}"
}

print_info() {
    echo -e "${BLUE}‚ÑπÔ∏è  $1${NC}"
}

# =============================================================================
# FONCTIONS D'INSTALLATION
# =============================================================================

confirm_fresh_install() {
    echo -e "${YELLOW}"
    echo "‚ö†Ô∏è  ATTENTION: Cette installation va:"
    echo "   ‚Ä¢ Supprimer toutes les donn√©es existantes"
    echo "   ‚Ä¢ R√©installer toutes les d√©pendances"
    echo "   ‚Ä¢ Reconfigurer la base de donn√©es"
    echo "   ‚Ä¢ Recharger les donn√©es de d√©monstration"
    echo -e "${NC}"
    
    read -p "√ätes-vous s√ªr de vouloir continuer? [y/N] " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        print_info "Installation annul√©e"
        exit 0
    fi
}

stop_existing_services() {
    print_step "Arr√™t des services existants..."
    
    if [ -f "./stop-app.sh" ]; then
        ./stop-app.sh > /dev/null 2>&1 || true
        print_success "Services existants arr√™t√©s"
    else
        print_warning "Script stop-app.sh non trouv√©, arr√™t manuel..."
        # Arr√™t manuel des processus
        pkill -f "vite" || true
        pkill -f "queue:work" || true
        pkill -f "npm run dev" || true
        docker compose down || true
    fi
}

clean_environment() {
    print_step "Nettoyage de l'environnement..."
    
    # Supprimer les dossiers g√©n√©r√©s
    print_info "Suppression des dossiers temporaires..."
    rm -rf node_modules/
    rm -rf vendor/
    rm -rf public/build/
    rm -rf storage/logs/*.log
    
    # Nettoyer les fichiers de cache
    rm -rf bootstrap/cache/*.php || true
    rm -rf storage/framework/cache/data/* || true
    rm -rf storage/framework/sessions/* || true
    rm -rf storage/framework/views/* || true
    
    # Supprimer les fichiers PID
    rm -f *.pid
    rm -f startup.log
    
    print_success "Environnement nettoy√©"
}

setup_fresh_environment() {
    print_step "Configuration de l'environnement..."
    
    # Sauvegarder .env existant si pr√©sent
    if [ -f .env ]; then
        cp .env .env.backup.$(date +%Y%m%d_%H%M%S)
        print_info "Sauvegarde de .env cr√©√©e"
    fi
    
    # Cr√©er nouveau .env depuis example
    if [ -f .env.example ]; then
        cp .env.example .env
        print_success "Nouveau fichier .env cr√©√©"
    else
        print_error "Fichier .env.example introuvable"
        exit 1
    fi
    
    # Configuration pour Sail/MySQL
    print_step "Configuration MySQL pour Sail..."
    cat > .env << EOF
APP_NAME="Services √† Domicile"
APP_ENV=local
APP_KEY=
APP_DEBUG=true
APP_URL=http://localhost:8080

APP_LOCALE=fr
APP_FALLBACK_LOCALE=fr
APP_FAKER_LOCALE=fr_FR

APP_MAINTENANCE_DRIVER=file
PHP_CLI_SERVER_WORKERS=4
BCRYPT_ROUNDS=12

LOG_CHANNEL=stack
LOG_STACK=single
LOG_DEPRECATIONS_CHANNEL=null
LOG_LEVEL=debug

# Base de donn√©es MySQL avec Sail
DB_CONNECTION=mysql
DB_HOST=mysql
DB_PORT=3306
DB_DATABASE=laravelvueservices
DB_USERNAME=sail
DB_PASSWORD=password

# Cache et sessions Redis
CACHE_STORE=redis
SESSION_DRIVER=redis
QUEUE_CONNECTION=redis
REDIS_HOST=redis
REDIS_PASSWORD=null
REDIS_PORT=6379

# Configuration email
MAIL_MAILER=smtp
MAIL_HOST=mailpit
MAIL_PORT=1025
MAIL_USERNAME=null
MAIL_PASSWORD=null
MAIL_ENCRYPTION=null
MAIL_FROM_ADDRESS="noreply@servicespro.local"
MAIL_FROM_NAME="Services √† Domicile"

# Stripe (pour les paiements)
STRIPE_KEY=pk_test_...
STRIPE_SECRET=sk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...

# Configuration Sail
APP_PORT=8080
FORWARD_DB_PORT=3307
FORWARD_REDIS_PORT=6380
FORWARD_MAILPIT_PORT=1026
FORWARD_MAILPIT_DASHBOARD_PORT=8026
VITE_PORT=5173

# Configuration Vite
VITE_APP_NAME="Services √† Domicile"
EOF
    
    print_success "Configuration .env cr√©√©e"
}

install_fresh_dependencies() {
    print_step "Installation des d√©pendances depuis z√©ro..."
    
    # V√©rifier Docker
    if ! docker info &> /dev/null; then
        print_error "Docker n'est pas en cours d'ex√©cution"
        exit 1
    fi
    
    # Installer les d√©pendances avec Sail depuis une image temporaire
    print_step "Installation Composer avec Sail..."
    
    # Cr√©er un conteneur temporaire pour Composer
    docker run --rm \
        -u "$(id -u):$(id -g)" \
        -v $(pwd):/var/www/html \
        -w /var/www/html \
        laravelsail/php84-composer:latest \
        composer install --ignore-platform-reqs --no-scripts
    
    print_success "D√©pendances Composer install√©es"
    
    # Maintenant Sail est disponible, d√©marrer les conteneurs
    print_step "D√©marrage des conteneurs Docker..."
    ./vendor/bin/sail up -d
    
    # Attendre que les services soient pr√™ts
    print_step "Attente des services Docker..."
    sleep 15
    
    # Finaliser l'installation Composer
    ./vendor/bin/sail composer install
    print_success "Installation Composer finalis√©e"
    
    # Installer Node.js dependencies
    print_step "Installation des d√©pendances Node.js..."
    npm ci
    print_success "D√©pendances Node.js install√©es"
}

setup_fresh_application() {
    print_step "Configuration de l'application Laravel..."
    
    # G√©n√©rer la cl√© d'application
    ./vendor/bin/sail artisan key:generate
    print_success "Cl√© d'application g√©n√©r√©e"
    
    # Effacer tous les caches
    ./vendor/bin/sail artisan config:clear
    ./vendor/bin/sail artisan cache:clear
    ./vendor/bin/sail artisan view:clear
    ./vendor/bin/sail artisan route:clear
    print_success "Caches vid√©s"
    
    # Cr√©er le lien de stockage
    ./vendor/bin/sail artisan storage:link
    print_success "Lien de stockage cr√©√©"
}

setup_fresh_database() {
    if [ "$RESET_DATABASE" = true ]; then
        print_step "Configuration de la base de donn√©es..."
        
        # Attendre que MySQL soit pr√™t
        print_info "V√©rification de la disponibilit√© de MySQL..."
        for i in {1..30}; do
            if ./vendor/bin/sail artisan tinker --execute="DB::connection()->getPdo(); echo 'OK';" &> /dev/null; then
                print_success "MySQL est disponible"
                break
            fi
            if [ $i -eq 30 ]; then
                print_error "MySQL non disponible apr√®s 5 minutes"
                exit 1
            fi
            sleep 10
            echo -n "."
        done
        echo
        
        # Reset complet de la base de donn√©es
        print_step "Reset complet de la base de donn√©es..."
        ./vendor/bin/sail artisan migrate:fresh --force
        print_success "Base de donn√©es r√©initialis√©e"
        
        # Installer les donn√©es de base (permissions, r√¥les)
        print_step "Installation des donn√©es de base..."
        ./vendor/bin/sail artisan db:seed --class=DatabaseSeeder --force
        print_success "Donn√©es de base install√©es"
        
        if [ "$INSTALL_DEMO_DATA" = true ]; then
            print_step "Installation des donn√©es de d√©monstration..."
            if ./vendor/bin/sail artisan db:seed --class=DemoDataSeeder --force; then
                print_success "Donn√©es de d√©monstration install√©es"
            else
                print_warning "Impossible d'installer les donn√©es de d√©monstration"
            fi
        fi
    fi
}

build_assets() {
    print_step "Construction des assets frontend..."
    
    # Build de production
    npm run build
    print_success "Assets construits"
}

# =============================================================================
# FONCTION PRINCIPALE
# =============================================================================

main() {
    print_header
    
    echo "=== Installation compl√®te d√©marr√©e √† $(date) ==="
    
    # Confirmation utilisateur
    confirm_fresh_install
    
    # Arr√™t des services existants
    stop_existing_services
    
    # Nettoyage complet
    clean_environment
    
    # Configuration environnement
    setup_fresh_environment
    
    # Installation d√©pendances
    install_fresh_dependencies
    
    # Configuration application
    setup_fresh_application
    
    # Configuration base de donn√©es
    setup_fresh_database
    
    # Construction assets
    build_assets
    
    echo
    echo -e "${GREEN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo -e "‚ïë               üéâ INSTALLATION TERMIN√âE ! üéâ                  ‚ïë"
    echo -e "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo
    echo -e "${WHITE}üöÄ Votre application est maintenant install√©e !${NC}"
    echo
    echo -e "${YELLOW}üìã Prochaines √©tapes:${NC}"
    echo -e "   1. ${CYAN}./start-app.sh${NC}     - D√©marrer l'application"
    echo -e "   2. Ouvrir ${CYAN}http://localhost:8080${NC}"
    echo -e "   3. Cr√©er votre premier compte admin"
    echo
    echo -e "${BLUE}üí° Comptes de d√©monstration disponibles:${NC}"
    echo -e "   ‚Ä¢ ${WHITE}Admin:${NC} admin@example.com / password"
    echo -e "   ‚Ä¢ ${WHITE}Client:${NC} client@example.com / password"
    echo -e "   ‚Ä¢ ${WHITE}Prestataire:${NC} provider@example.com / password"
    echo
    
    echo "=== Installation termin√©e avec succ√®s √† $(date) ==="
}

# =============================================================================
# OPTIONS DE LIGNE DE COMMANDE
# =============================================================================

show_help() {
    echo "Usage: $0 [OPTIONS]"
    echo
    echo "Installation compl√®te de l'application Laravel Vue Services"
    echo
    echo "OPTIONS:"
    echo "  -h, --help        Afficher cette aide"
    echo "  --no-demo         Ne pas installer les donn√©es de d√©monstration"
    echo "  --keep-database   Garder la base de donn√©es existante"
    echo
    echo "EXEMPLES:"
    echo "  $0                Installation compl√®te avec donn√©es de d√©mo"
    echo "  $0 --no-demo      Installation sans donn√©es de d√©monstration"
    echo
}

# Analyse des arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            show_help
            exit 0
            ;;
        --no-demo)
            INSTALL_DEMO_DATA=false
            shift
            ;;
        --keep-database)
            RESET_DATABASE=false
            shift
            ;;
        *)
            print_error "Option inconnue: $1"
            show_help
            exit 1
            ;;
    esac
done

# =============================================================================
# EX√âCUTION
# =============================================================================

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi